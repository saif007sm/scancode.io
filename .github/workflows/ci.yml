name: Django CI

on: [push, pull_request]

env:
  # Run tasks in the current thread, no need for workers in CI mode
  CELERY_TASK_ALWAYS_EAGER: True
  DB_HOST: postgres
  DB_USERNAME: postgres
  DB_PASSWORD: postgres
#  POSTGRES_DB: scancodeio
#  POSTGRES_USER: scancodeio
#  POSTGRES_PASSWORD: scancodeio

jobs:
  build:

    runs-on: ubuntu-20.04
    services:
      postgres:
        image: postgres:10
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports: 5432:5432
        # needed because the postgres container does not provide a healthcheck
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5


    steps:
      - name: PostgreSQL
        run: |
          psql -c "\l"
          createdb test
        env:
          POSTGRES_HOST: postgres
          POSTGRES_PORT: ${{ job.services.postgres.ports[5432] }}

#    strategy:
#      max-parallel: 4
#      matrix:
#        python-version: [3.6, 3.7, 3.8, 3.9]
#
#    services:
#      postgres:
#        image: postgres:10
#        env:
#          POSTGRES_DB: ${{ env.POSTGRES_DB }}
#          POSTGRES_USER: ${{ env.POSTGRES_USER }}
#          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
#          POSTGRES_HOST_AUTH_METHOD: trust
#        ports:
#          - 5432:5432
#        options: >-
#          --health-cmd pg_isready
#          --health-interval 10s
#          --health-timeout 5s
#          --health-retries 5
#
#    steps:
#    - uses: actions/checkout@v2
#    - name: Set up Python ${{ matrix.python-version }}
#      uses: actions/setup-python@v2
#      with:
#        python-version: ${{ matrix.python-version }}
#    - name: Install Dependencies
#      run: |
#        make dev
#        make envfile
#    - name: Check Code Validation
#      run: |
#        make check
#    - name: Create Database
#      run: |
#        createdb --encoding=utf-8 -p 5432 -U ${{ env.POSTGRES_USER }} ${{ env.POSTGRES_DB }}
#      env:
#        PGPASSWORD: postgres
#    - name: Run Tests
#      run: |
#        python manage.py test --settings=scancodeio.settings.base --verbosity=2 --noinput
